<!DOCTYPE html>
<html>

<head>
	<!--Import Google Icon Font-->
	<link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<!--Import materialize.css-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/css/materialize.min.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css">
	<link rel="stylesheet" href="style.css">

	<!--Let browser know website is optimized for mobile-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>ESP Power Monitoring</title>
</head>

<body class="bg">
	<nav>
		<div class="nav-wrapper">
			<a href="#!" class="brand-logo center">ESP Power Monitoring</a>
			<ul class="right hide-on-small-and-down">
				<li>
					<a href="index.html">Visualisation</a>
				</li>
				<li class="active">
					<a href="config.html">Configuration</a>
				</li>
			</ul>
		</div>
	</nav>

	<div class="container">
		<div class="row"></div>
		<div class="row">

			<div id="Global" class="col s12 m12 l12">
				<div class="row"></div>
				<div class="input-field col s12">
					<input id="hostname" type="text">
					<label for="hostname">Hostname</label>
				</div>
				<div class="input-field col s6">
					<input id="mqttIpServer" type="text">
					<label for="mqttIpServer">MQTT Ip Server</label>
				</div>
				<div class="input-field col s6">
					<input id="mqttPortServer" type="text">
					<label for="mqttPortServer">MQTT Port Server</label>
				</div>
				<div class="input-field col s6">
					<input id="mqttUsername" type="text">
					<label for="mqttUsername">MQTT Username</label>
				</div>
				<div class="input-field col s6">
					<input id="mqttPassword" type="text">
					<label for="mqttPassword">MQTT Password</label>
				</div>
				<div class="input-field col s3">
					<input id="timeSaveData" type="text">
					<label for="timeSaveData">NTP and Save Data Intervale (s)</label>
				</div>
				<div class="input-field col s3">
					<input id="timeSendData" type="text">
					<label for="timeSendData">Send Data Intervale (s)</label>
				</div>
				<div class="input-field col s3">
					<input id="mode" type="text">
					<label for="mode">Mode (0: Mono, 1: 1x Tri, 2: 2x Tri)</label>
				</div>
				<div class="input-field col s3">
					<input id="timeoutRelay" type="text">
					<label for="timeoutRelay">Timeout relay (s)</label>
				</div>
				<div class="input-field col s4">
					<input id="nameA" type="text">
					<label for="nameA">Name line A</label>
				</div>
				<div class="input-field col s4">
					<input id="nameB" type="text">
					<label for="nameB">Name line B</label>
				</div>
				<div class="input-field col s4">
					<input id="nameC" type="text">
					<label for="nameC">Name line C</label>
				</div>
				<div class="input-field col s4">
					<input id="currentClampA" type="text">
					<label for="currentClampA">Max Current Sensor, line A (A)</label>
				</div>
				<div class="input-field col s4">
					<input id="currentClampB" type="text">
					<label for="currentClampB">Max Current Sensor, line B (A)</label>
				</div>
				<div class="input-field col s4">
					<input id="currentClampC" type="text">
					<label for="currentClampC">Max Current Sensor, line C (A)</label>
				</div>
				<div class="input-field col s4">
					<input id="consoA" type="text">
					<label for="consoA">Conso, line A</label>
				</div>
				<div class="input-field col s4">
					<input id="consoB" type="text">
					<label for="consoB">Conso, line B</label>
				</div>
				<div class="input-field col s4">
					<input id="consoC" type="text">
					<label for="consoC">Conso, line C</label>
				</div>
				<div class="col s12 m12 l12" align="left">
					<a class="waves-effect waves-light btn" onClick="save()">
						<i class="material-icons right">send</i>
						Enregistrer
					</a>
				</div>
				<div class="col s12 m12 l12" align="right">
					<a class="waves-effect waves-ligt btn-small modal-trigger" onClick="restart()" href="#modal1">
						<i class="material-icons left">autorenew</i>
						Red&eacute;marrer
					</a>
				</div>
			</div>

			<!-- Modal Structure -->
			<div id="modal1" class="modal">
				<div class="modal-content">
					<h4>Red&eacute;marrage en cours</h4>
					<p>Veuillez patientez</p>
					<div class="progress">
						<div class="indeterminate"></div>
					</div>
				</div>
			</div>

		</div>

	</div>

	<!--Import jQuery before materialize.js-->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/js/materialize.min.js"></script>
	<script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jscolor/2.0.4/jscolor.js"></script>

	<script>
		var ENV_PROD = true;

		var URI;
		if (ENV_PROD == true) {
			URI = document.location.origin + "/";
		} else {
			// URI = "http://192.168.1.19/";
			URI = "http://10.65.30.42/";
		}

		var errorConnectionToast;

		function restart() {
			$.post(URI + "restart")
				.done(function (res) {
					// M.toast({ html: "Red&eacute;marrage en cours..." });
					pooling();
				})
				.fail(function () {
					/* Display Toast Error */
					if (!errorConnectionToast) {
						errorConnectionToast = M.toast({ html: "Impossible de communiquer avec le device !" });
					}
				})
				.always(function () {
				});
		}

		function save() {
			var json = {};
			json = {};
			json.hostname = $('#hostname').val();
			json.mqttIpServer = $('#mqttIpServer').val();
			json.mqttPortServer = parseInt($('#mqttPortServer').val());
			json.mqttUsername = $('#mqttUsername').val();
			json.mqttPassword = $('#mqttPassword').val();
			json.timeSaveData = parseInt($('#timeSaveData').val());
			json.timeSendData = parseInt($('#timeSendData').val());
			json.mode = parseInt($('#mode').val());
			json.nameA = $('#nameA').val();
			json.nameB = $('#nameB').val();
			json.nameC = $('#nameC').val();
			json.currentClampA = parseInt($('#currentClampA').val());
			json.currentClampB = parseInt($('#currentClampB').val());
			json.currentClampC = parseInt($('#currentClampC').val());
			json.consoA = parseInt($('#consoA').val());
			json.consoB = parseInt($('#consoB').val());
			json.consoC = parseInt($('#consoC').val());
			json.timeoutRelay = parseInt($('#timeoutRelay').val());

			$.post(URI + "config", JSON.stringify(json))
				.done(function (res) {
					M.toast({ html: "Configuration sauvegard&eacute; !" });
					getConfig();
				})
				.fail(function () {
					/* Display Toast Error */
					if (!errorConnectionToast) {
						errorConnectionToast = M.toast({ html: "Impossible d'envoyer la configuration !" });
					}
				})
				.always(function () {
				});
		}

		function pooling() {
			let abortController = new AbortController();
			let abortSignal = abortController.signal;

			let abortTimeout = setTimeout(() => {
				abortController.abort();
				// console.log('aborted');
				pooling();
			}, 1000)

			fetch(URI + 'config.json', {
				mode: 'cors',
				signal: abortSignal
			}).then(response => {
				clearTimeout(abortTimeout);
				location.reload();
			}).catch(error => {
			});
		}

		function getConfig() {
			console.log("try to read config...")
			fetch(URI + 'config.json', {
				mode: 'cors',
			}).then(response =>
				response.json()
			).then(params => {
				// {
				// 	"hostname": "ESP_Monitoring",
				// 	"mqttIpServer": "192.168.1.201",
				// 	"mqttPortServer": 1883,
				// 	"mqttUsername": "",
				// 	"mqttPassword": "",
				// 	"timeSaveData": 3600,
				// 	"timeSendData": 5,
				// 	"mode": 0,
				// 	"nameA": "lineA",
				// 	"nameB": "lineB",
				// 	"nameC": "lineC",
				// 	"currentClampA": 30,
				// 	"currentClampB": 30,
				// 	"currentClampC": 60,
				// 	"consoA": 0,
				// 	"consoB": 0,
				// 	"consoC": 0,
				//  "timeoutRelay": 0
				// }

				console.log("configuration read successfully !")

				/* Remove Toast */
				if (errorConnectionToast)
					errorConnectionToast.remove();

				console.log("data receive: " + JSON.stringify(params, null, 2));

				/* Add Data to GUI */
				$('#hostname').val(params.hostname);
				$('#mqttIpServer').val(params.mqttIpServer);
				$('#mqttPortServer').val(params.mqttPortServer);
				$('#mqttUsername').val(params.mqttUsername);
				$('#mqttPassword').val(params.mqttPassword);
				$('#timeSaveData').val(params.timeSaveData);
				$('#timeSendData').val(params.timeSendData);
				$('#mode').val(params.mode);
				$('#nameA').val(params.nameA);
				$('#nameB').val(params.nameB);
				$('#nameC').val(params.nameC);
				$('#currentClampA').val(params.currentClampA);
				$('#currentClampB').val(params.currentClampB);
				$('#currentClampC').val(params.currentClampC);
				$('#consoA').val(params.consoA);
				$('#consoB').val(params.consoB);
				$('#consoC').val(params.consoC);
				$('#timeoutRelay').val(params.timeoutRelay);
				M.updateTextFields();
			}).catch(error => {
				/* Display Toast Error */
				if (!errorConnectionToast) {
					errorConnectionToast = M.toast({ html: "Impossible de communiquer avec le device !" });
				}
			})
		}

		$(document).ready(function () {
			console.log("ready !");
			getConfig();

			// Initialize Modal
			M.Modal.init(document.querySelectorAll('.modal'), {
				dismissible: false
			});
		});

	</script>
</body>

</html>
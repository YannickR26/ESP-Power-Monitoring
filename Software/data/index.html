<!DOCTYPE html>
<html>

<head>
    <!--Import Google Icon Font-->
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/css/materialize.min.css">
    <link rel="stylesheet" href="style.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.css"> -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.css">

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP Power Monitoring</title>
</head>

<body class="bg">
    <nav>
        <div class="nav-wrapper">
            <a href="#!" class="brand-logo center">ESP Power Monitoring</a>
            <ul class="left hide-on-small-and-down">
                <div id='version'></div>
            </ul>
            <ul class="right hide-on-small-and-down">
                <li class="active">
                    <a href="index.html">Visualisation</a>
                </li>
                <li>
                    <a href="config.html">Configuration</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col s12 m4 offset-m4">
                <div class="card blue-grey darken-1">
                    <div class="card-content white-text">
                        Relais
                        <div class="switch">
                            <label class="white-text">
                                <input id="relay" type="checkbox">
                                <span class="lever"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="linesContainer"></div>

    </div>

    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/js/materialize.min.js"></script>
    <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

    <script>
        var ENV_PROD = false;

        var URI;
        if (ENV_PROD == true) {
            URI = document.location.origin + "/";
        } else {
            URI = "http://192.168.1.17/";
            // URI = "http://10.65.30.68/";
        }

        const config = {
            lines: [
                {
                    name: 'lineA'
                },
                {
                    name: 'lineB'
                },
                {
                    name: 'lineC'
                },
            ],
            lineFields: [
                {
                    name: "Voltage",
                    fieldName: "voltage",
                    unit: 'V',
                    color: "#00FF00",
                    axis: 'y1'
                },
                {
                    name: "Current",
                    fieldName: 'current',
                    unit: 'A',
                    color: "#FF0000",
                    axis: 'y'
                },
                {
                    name: "Power",
                    fieldName: 'power',
                    unit: 'kW/h',
                    color: "#0000FF",
                    axis: 'y'
                },
                {
                    name: "Cos phy",
                    fieldName: "cosPhy",
                    unit: '',
                    color: "#FF00FF",
                    axis: 'y'
                },
                {
                    name: "Conso",
                    fieldName: 'conso',
                    unit: 'kW',
                    color: "#FFFF00",
                    axis: 'y'
                }
            ]
        };

        for (currentLine of config.lines) {
            let container = document.createElement('div');
            container.classList.add('row');

            let valuesContainer = document.createElement('div');
            valuesContainer.classList.add('col', 's12', 'm4');
            container.appendChild(valuesContainer);

            let cardValue = document.createElement('div');
            cardValue.classList.add('card', 'blue-grey', 'darken-1');
            valuesContainer.appendChild(cardValue);

            let cardContent = document.createElement('div');
            cardContent.classList.add('card-content', 'white-text');
            cardValue.appendChild(cardContent);

            let cardTitle = document.createElement('span');
            cardTitle.classList.add('card-title');
            cardContent.appendChild(cardTitle);

            for (let lineField of config.lineFields) {
                let fieldContainer = document.createElement('div');
                fieldContainer.classList.add('row');

                let name = document.createElement('div');
                name.classList.add('col', 's4');
                name.textContent = lineField.name;
                fieldContainer.appendChild(name);

                let value = document.createElement('div');
                value.classList.add('col', 's4');
                value.id = currentLine.name + '-' + lineField.fieldName;
                fieldContainer.appendChild(value);

                let unit = document.createElement('div');
                unit.classList.add('col', 's4');
                unit.textContent = lineField.unit;
                fieldContainer.appendChild(unit);

                cardContent.appendChild(fieldContainer);
            }

            let graphContainer = document.createElement('div');
            graphContainer.classList.add('col', 's12', 'm8');
            container.appendChild(graphContainer);

            let cardGraph = document.createElement('div');
            cardGraph.classList.add('card', 'blue-grey', 'darken-1');
            graphContainer.appendChild(cardGraph);

            cardContent = document.createElement('div');
            cardContent.classList.add('card-content', 'white-text');
            cardGraph.appendChild(cardContent);

            let chartElement = document.createElement('canvas');
            chartElement.width = "400";
            chartElement.height = "105";
            chartElement.id = currentLine.name + 'chart';
            cardGraph.appendChild(chartElement);

            document.querySelector('#linesContainer').appendChild(container);
        }

        let chartsData = config.lines.map(line => ({
            labels: [],
            datasets: config.lineFields.map(confField => ({
                label: confField.name,
                borderColor: confField.color,
                backgroundColor: confField.color,
                fill: false,
                data: [],
                yAxisId: confField.axis
            }))
        }));


        let chartsOptions = {
            responsive: true,
            stacked: false,
            tooltips: {
                mode: 'index',
                intersect: false,
            },
            hover: {
                mode: 'nearest',
                intersect: true
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                }
            }
        };

        // Create a new line chart object where as first parameter we pass in a selector
        // that is resolving to our chart container element. The Second parameter
        // is the actual data object.
        var charts = {};
        config.lines.forEach((currentLine, index) => {
            charts[index] = new Chart(currentLine.name + 'chart', { type: 'line', data: chartsData[index], options: chartsOptions });
        });

        Chart.defaults.global.defaultFontColor = 'white';

        var poolingtimer;
        var errorConnectionToast;

        function pooling(callback) {
            //every 500ms
            $.get(URI + "status")
                .done(function (res) {
                    // {
                    //     "version": "V1.7.0",
                    //     "build": "Jun  7 2020 11:25:17",
                    //     "relay": 0,
                    //     "lineA": {
                    //         "voltage": 655.35,
                    //         "current": 65.535,
                    //         "power": 0.00032,
                    //         "cosPhy": 0.001,
                    //         "conso": 8.888889e-10
                    //     },
                    //     "lineB": {
                    //         "voltage": 655.35,
                    //         "current": 65.535,
                    //         "power": 0.00032,
                    //         "cosPhy": 0.001,
                    //         "conso": 8.888889e-10
                    //     },
                    //     "lineC": {
                    //         "voltage": 655.35,
                    //         "current": 65.535,
                    //         "power": 0.00032,
                    //         "cosPhy": 0.001,
                    //         "conso": 8.888889e-10
                    //     }
                    // }

                    if (errorConnectionToast)
                        errorConnectionToast.remove();

                    if (res.relay == 0)
                        $("#relay").prop('checked', false);
                    else
                        $("#relay").prop('checked', true);

                    $('#version').text(res.version);

                    const nbMaxPoint = 28;
                    let removeFirstPoint = false;
                    config.lines.forEach((currentLine, index) => {
                        var lineData = chartsData[index];
                        lineData.labels.push(new Date().toLocaleTimeString());
                        config.lineFields.forEach((confField, indexConf) => {
                            $("#" + currentLine.name + '-' + confField.fieldName).text(res[currentLine.name][confField.fieldName]);
                            let data = lineData.datasets[indexConf].data;
                            data.push({
                                x: data.length,
                                y: parseFloat(res[currentLine.name][confField.fieldName])
                            });
                            if (data.length > nbMaxPoint) {
                                data.splice(0, 1);
                                removeFirstPoint = true;
                            }
                        });
                        if (removeFirstPoint) {
                            lineData.labels.splice(0, 1);
                        }
                        charts[index].update();
                    });

                    poolingtimer = setTimeout(pooling, 1000);
                    if (callback)
                        callback();
                })
                .fail(function () {
                    poolingtimer = setTimeout(pooling, 3000);
                    if (!errorConnectionToast) {
                        errorConnectionToast = M.toast({ html: "Impossible de communiquer avec le device !" });
                    }
                })
                .always(function () {

                });
        }

        $("#relay").click(function () {
            if ($('#relay').is(':checked')) {
                $.get(URI + "set?relay=1");
            } else {
                $.get(URI + "set?relay=0");
            }
        });

        poolingtimer = setTimeout(pooling, 1000);

    </script>
</body>

</html>
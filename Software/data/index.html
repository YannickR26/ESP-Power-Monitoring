<!DOCTYPE html>
<html>

<head>
    <!--Import Google Icon Font-->
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/css/materialize.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP Power Monitoring</title>
</head>

<body class="bg">
    <nav>
        <div class="nav-wrapper">
            <a href="#!" class="brand-logo center">ESP Power Monitoring</a>
            <ul class="right hide-on-small-and-down">
				<li class="active">
					<a href="index.html">Visualisation</a>
				</li>
				<li>
					<a href="config.html">Configuration</a>
				</li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="row"></div>
        <div class="row">
            <div class="col s12 m12 l4 offset-l4">
                <div class="card blue-grey darken-1">
                    <div class="card-content white-text">
                        Mode Automatique
                        <div class="switch">
                            <label class="white-text">
                                <input id="mode" type="checkbox">
                                <span class="lever"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- <div class = "row"> 
                <div class="col m12 l6 ">
                    <div class="card blue-grey darken-1 lower-card">
                        <div class="card-content white-text">
                            <span class="card-title">Eclairage du luminaire</span>
                            <div id="slider"></div>
                        </div>
                    </div>
                </div>
                <div class="col m12  l6">
                    <div class="card blue-grey darken-1 lower-card">
                        <div class="card-content white-text">
                            <div class="ct-chart"></div>
                        </div>
                    </div>
                </div>
            </div> -->
    </div>

    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/js/materialize.min.js"></script>
    <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>
    <script src="api.js"></script>

    <script>
        var ENV_PROD = false;

        var URI;
        if (ENV_PROD == true) {
            URI = document.location.origin + "/";
        } else {
            URI = "http://192.168.1.17/";
        }

        var poolingtimer;
        var errorConnectionToast;
        var params;

        function pooling(callback) {
            //every 500ms
            $.get(URI + "status")
                .done(function (res) {
                    // {
                    //     "version": "V1.7.0",
                    //     "build": "Jun  7 2020 11:25:17",
                    //     "relay": 0,
                    //     "lineA": {
                    //         "voltage": 655.35,
                    //         "current": 65.535,
                    //         "power": 0.00032,
                    //         "cosPhy": 0.001,
                    //         "conso": 8.888889e-10
                    //     },
                    //     "lineB": {
                    //         "voltage": 655.35,
                    //         "current": 65.535,
                    //         "power": 0.00032,
                    //         "cosPhy": 0.001,
                    //         "conso": 8.888889e-10
                    //     },
                    //     "lineC": {
                    //         "voltage": 655.35,
                    //         "current": 65.535,
                    //         "power": 0.00032,
                    //         "cosPhy": 0.001,
                    //         "conso": 8.888889e-10
                    //     }
                    // }

                    if (errorConnectionToast)
                        errorConnectionToast.remove();

                    var lineA = res.lineA;
                    var lineB = res.lineB;
                    var lineC = res.lineC;

                    poolingtimer = setTimeout(pooling, 500);
                    if (callback)
                        callback();
                })
                .fail(function () {
                    poolingtimer = setTimeout(pooling, 2000);
                    if (!errorConnectionToast) {
						errorConnectionToast = M.toast({ html: "Impossible de communiquer avec le device !" });
                    }
                })
                .always(function () {

                });
        }

        $("#mode").click(function () {
            //on change de mode
            var mode;
            if ($('#mode').is(':checked')) {
                $.get(URI + "rest/mode/auto");
            } else {
                $.get(URI + "rest/mode/manual");
                //on envoie Ã©galemenet la valeur courante
                $.get(URI + "rest/led/" + slider.getValue());
            }
        });

        poolingtimer = setTimeout(pooling, 500);

        var responsiveOptions = [
            ['screen and (min-width: 641px) and (max-width: 1024px)', {
                seriesBarDistance: 10,
                axisX: {
                    labelInterpolationFnc: function (value) {
                        return value;
                    }
                }
            }],
            ['screen and (max-width: 640px)', {
                seriesBarDistance: 5,
                axisX: {
                    labelInterpolationFnc: function (value) {
                        return value[0];
                    }
                }
            }]
        ];

        // Create a new line chart object where as first parameter we pass in a selector
        // that is resolving to our chart container element. The Second parameter
        // is the actual data object.
        var chart = new Chartist.Line('.ct-chart', data, options, responsiveOptions);

        //Chartist animation
        //animateChart(chart);

        var slider = $("#slider").roundSlider({
            handleShape: "dot",
            width: "50",
            radius: "100",
            value: 622,
            editableTooltip: false,
            keyboardAction: false,
            mouseScrollAction: false,
            max: "100",
            startAngle: 90,
            sliderType: "min-range",
            circleShape: "half-top",

            change: function (args) {
                $.get(URI + "rest/led/" + slider.getValue());
            }
        }).data("roundSlider");

        $(".modal").modal();


        $("#configuration-btn").click(function () {
            $('#configuration-modal').modal('open');
            //clearTimeout(poolingtimer);
            /*pooling(function() {
                $("#txt-date-start").val(params.timeStart.h + ":" + params.timeStart.m);
                
                $("#txt-start-duration").val(params.startduration);
                
                $("#txt-date-end").val(params.timeEnd.h + ":" + params.timeEnd.m);
                
                $("#txt-end-duration").val(params.endDuration);

                $('#configuration-modal').modal('open');

                M.updateTextFields();
            }); */
        });

        $("#validate-configuration-btn").click(function () {
            $('#configuration-modal').modal('close');
            $.get(URI + "rest/param/time-start/" + timeToSimestamp($("#txt-date-start").val()))
                .done(() => {
                    $.get(URI + "rest/param/time-end/" + timeToSimestamp($("#txt-date-end").val()))
                        .done(() => {
                            $.get(URI + "rest/param/start-duration/" + $("#txt-start-duration").val())
                                .done(() => {
                                    $.get(URI + "rest/param/end-duration/" + $("#txt-end-duration").val())
                                        .done(() => {
                                            M.toast("Parameters saved", 3000);
                                        });
                                });
                        });
                });
        });

    </script>
</body>

</html>